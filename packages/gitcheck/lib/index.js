#! /usr/bin/env node
import e from"picocolors";import o from"path";import{glob as t}from"glob";import{simpleGit as i}from"simple-git";import l from"ora";import r from"cac";async function n(r){r=r||process.cwd();const n=l("分析目录中").start(),d=await t("**/.git/",{cwd:r,ignore:"node_modules/**"});if(0==d.length)return void n.succeed(e.green(`分析完成! 未发现git项目(${e.italic(r)})`));const s=d.map((async e=>{const t=o.resolve(r,e,".."),l=await async function(e){const o=i(e,{binary:"git"}),t=await o.status().then((o=>({ahead:o.ahead,gitDir:e,unsafeDir:!1,staged:o.staged.length>0,not_added:o.not_added.length>0,modified:o.modified.length>0}))).catch((o=>({gitDir:e,unsafeDir:o.message.includes("config --global --add safe.directory")})));return t}(t);return l}));Promise.all(s).then((o=>{const t=o.filter((e=>e.unsafeDir)).map((e=>e.gitDir)),i=o.filter((e=>e.staged)).map((e=>e.gitDir)),l=o.filter((e=>e.not_added&&!e.staged)).map((e=>e.gitDir)),d=o.filter((e=>e.ahead)).map((e=>e.gitDir));n.succeed(e.green(`${e.bold("目录分析完成")} (${e.italic(r)})`)),t.length>0&&(console.log(e.bgBlue(`🚀 insecure directory（${t.length}）: `)),t.sort().map((o=>console.log(e.italic(e.red(o)))))),l.length>0&&(a(void 0,void 0,void 0,l.length),l.sort().map((o=>console.log(e.italic(e.yellow(o)))))),i.length>0&&(a("add",void 0,void 0,i.length),i.sort().map((o=>console.log(e.italic(e.yellow(o)))))),d.length>0&&(a("add","commit",void 0,d.length),d.sort().map((o=>console.log(e.italic(e.yellow(o)))))),0===t.length&&0===l.length&&0===i.length&&0===d.length&&console.log(e.green("✅ 已全部提交且推送"))})).catch((o=>{n.fail(e.red("分析失败")),console.log(e.red(o))}))}function a(o,t,i,l=0){const r=e=>e?"✅":"❌";console.log(e.bgBlue(`🚀 add${r(o)} commit${r(t)} push${r(i)}（${l}）: `))}const d=r();d.help(),d.version("0.0.9-beta.2"),d.option("-d ,--dir <dir>","Parse folder",{default:"."}),d.command("rm <dir>","Remove a dir").option("-r, --recursive","Remove recursively").action(((e,o)=>{console.log("options: ",o),console.log("remove "+e)})),d.command("[...files]","files").action(((e,t)=>{n(o.resolve(t.dir))})),d.parse();
