#! /usr/bin/env node
import t from"picocolors";import e from"path";import{glob as o}from"glob";import{simpleGit as i}from"simple-git";import r from"ora";import n from"cac";import{execSync as s}from"child_process";async function c(n){n=n||process.cwd();const s=r("åˆ†æç›®å½•ä¸­").start(),c=await o("**/.git/",{cwd:n,ignore:"node_modules/**"});if(0==c.length)return void s.succeed(t.green(`åˆ†æå®Œæˆ! æœªå‘ç°gité¡¹ç›®(${t.italic(n)})`));const l=c.map((async t=>{const o=e.resolve(n,t,".."),r=await async function(t){const e=i(t,{binary:"git"}),o=await e.status().then((e=>({ahead:e.ahead,gitDir:t,unsafeDir:!1,staged:e.staged.length>0,not_added:e.not_added.length>0,modified:e.modified.length>0}))).catch((e=>({gitDir:t,unsafeDir:e.message.includes("config --global --add safe.directory")})));return o}(o);return r}));Promise.all(l).then((e=>{const o=e.filter((t=>t.unsafeDir)).map((t=>t.gitDir)),i=e.filter((t=>t.staged)).map((t=>t.gitDir)),r=e.filter((t=>t.modified&&!t.staged)).map((t=>t.gitDir)),c=e.filter((t=>t.not_added&&!t.staged)).map((t=>t.gitDir)),l=[...new Set([...r,...c])],g=e.filter((t=>t.ahead)).map((t=>t.gitDir));s.succeed(t.green(`${t.bold("ç›®å½•åˆ†æå®Œæˆ")} (${t.italic(n)})`)),o.length>0&&(console.log(t.bgBlue(`ğŸš€ insecure directoryï¼ˆ${o.length}ï¼‰: `)),o.sort().map((t=>a(t)))),l.length>0&&(d(void 0,void 0,void 0,l.length),l.sort().map((t=>a(t)))),i.length>0&&(d("add",void 0,void 0,i.length),i.sort().map((t=>a(t)))),g.length>0&&(d("add","commit",void 0,g.length),g.sort().map((t=>a(t)))),0===o.length&&0===c.length&&0===i.length&&0===g.length&&console.log(t.green("âœ… å·²å…¨éƒ¨æäº¤ä¸”æ¨é€"))})).catch((e=>{s.fail(t.red("åˆ†æå¤±è´¥")),console.log(t.red(e))}))}function d(e,o,i,r=0){const n=t=>t?"âœ…":"âŒ";console.log(t.bgBlue(`ğŸš€ add${n(e)} commit${n(o)} push${n(i)}ï¼ˆ${r}ï¼‰: `))}function a(e){console.log(t.italic(t.yellow(e)))}const l=n();l.help(),l.version("0.0.1"),l.command("push [dir]","git push with retry").option("-d, --dir <dir>","Execute git push with retry",{default:"."}).option("-r, --retry <number>","Retry attempts count",{default:1}).action(((t,o)=>{const i=t||o.dir;!function(t=process.cwd(),e=1){let o=!1;for(;e>0&&!o;)try{console.log(`æ‰§è¡Œgit push (å‰©ä½™é‡è¯•æ¬¡æ•°: ${e})`),s("git push",{cwd:t,stdio:"inherit"}),o=!0,console.log("[32m%s[0m","âœ… æ“ä½œå®Œæˆ")}catch(t){e--,console.log("[31m%s[0m",`æ¨é€å¤±è´¥ï¼Œ${e}æ¬¡é‡è¯•æœºä¼š`),0===e&&(console.error("[31m%s[0m","git pushé‡è¯•æ¬¡æ•°ç”¨å°½"),process.exit(1))}}(e.resolve(i),o.retry)})),l.command("check [dir]","Check git repo").option("-d ,--dir <dir>","Parse folder",{default:"."}).action(((t,o)=>{const i=t||o.dir;c(e.resolve(i))})),l.command("[...files]","files").action(((t,e)=>{c(process.cwd())})),l.parse();
