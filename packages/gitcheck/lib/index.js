#! /usr/bin/env node
import e from"picocolors";import o from"path";import{glob as i}from"glob";import{simpleGit as t}from"simple-git";import l from"ora";import n from"cac";async function r(n){n=n||process.cwd();const r=l("分析目录中").start(),d=await i("**/.git/",{cwd:n,ignore:"node_modules/**"});if(0==d.length)return void r.succeed(e.green(`分析完成! 未发现git项目(${e.italic(n)})`));const c=d.map((async e=>{const i=o.resolve(n,e,".."),l=await async function(e){const o=t(e,{binary:"git"}),i=await o.status().then((o=>({ahead:o.ahead,gitDir:e,unsafeDir:!1,staged:o.staged.length>0,not_added:o.not_added.length>0,modified:o.modified.length>0}))).catch((o=>({gitDir:e,unsafeDir:o.message.includes("config --global --add safe.directory")})));return i}(i);return l}));Promise.all(c).then((o=>{const i=o.filter((e=>e.unsafeDir)).map((e=>e.gitDir)),t=o.filter((e=>e.staged)).map((e=>e.gitDir)),l=o.filter((e=>e.not_added&&!e.staged)).map((e=>e.gitDir)),d=o.filter((e=>e.ahead)).map((e=>e.gitDir));r.succeed(e.green(`${e.bold("目录分析完成")} (${e.italic(n)})`)),i.length>0&&(console.log(e.bgBlue(`🚀 insecure directory（${i.length}）: `)),i.map((o=>console.log(e.italic(e.red(o)))))),l.length>0&&(a(void 0,void 0,void 0,l.length),l.map((o=>console.log(e.italic(e.yellow(o)))))),t.length>0&&(a("add",void 0,void 0,t.length),t.map((o=>console.log(e.italic(e.yellow(o)))))),d.length>0&&(a("add","commit",void 0,d.length),d.map((o=>console.log(e.italic(e.yellow(o)))))),0===i.length&&0===l.length&&0===t.length&&0===d.length&&console.log(e.green("✅ 已全部提交且推送"))})).catch((o=>{r.fail(e.red("分析失败")),console.log(e.red(o))}))}function a(o,i,t,l=0){const n=e=>e?"✅":"❌";console.log(e.bgBlue(`🚀 add${n(o)} commit${n(i)} push${n(t)}（${l}）: `))}const d=n();d.help(),d.version("0.0.9-beta.1"),d.option("-d ,--dir <dir>","Parse folder",{default:"."}),d.command("rm <dir>","Remove a dir").option("-r, --recursive","Remove recursively").action(((e,o)=>{console.log("options: ",o),console.log("remove "+e)})),d.command("[...files]","files").action(((e,i)=>{r(o.resolve(i.dir))})),d.parse();
